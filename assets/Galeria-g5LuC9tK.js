import{A as f,u,B as b,C as k,D as y,_ as v,a as d,b as t,d as h,j as m,t as w,k as I,F as p,x as S,o as c,w as _}from"./index-BHCqwZJN.js";import{_ as x}from"./rustic-z3WfS5tK.js";const C=f("media",{state:()=>({socket:null,media:[],isUploading:!1,uploadProgress:0,isConnected:!1,imagePreview:null}),getters:{token(){return u().token}},actions:{connectSocket(){this.token?(console.log("🔗 Conectando al socket con el token de usuario..."),k(this.token),this.socket=y(),this.socket.on("connect",()=>{this.isConnected=!0,console.log("✅ Conectado al socket."),this.fetchAllImages()}),this.socket.on("disconnect",e=>{this.isConnected=!1,console.log(`❌ Socket desconectado. Razón: ${e}`)}),this.subscribeToEvents()):console.warn("⚠️ No hay token disponible, no se puede conectar al socket.")},watchAuthToken(){u().$subscribe((s,o)=>{o.token&&(console.log("🔄 Token cambiado, actualizando socket..."),b(o.token))})},subscribeToEvents(){this.socket&&(this.socket.off("gallery:newImage").on("gallery:newImage",e=>{console.log("📷 Nueva imagen recibida:",e),this.addNewImage(e),this.saveImagesToLocalStorage()}),this.socket.on("gallery:imageList",e=>{console.log("📷 Lista de imágenes recibida:",e),this.media=e.map(s=>({type:"image",url:s.url,filename:s.filename})),this.saveImagesToLocalStorage()}),this.socket.off("gallery:uploadImageChunk").on("gallery:uploadImageChunk",e=>{console.log("📡 Respuesta de subida de imagen:",e),this.isUploading=!1,e.status==="ok"?(this.fetchAllImages(),this.imagePreview=null):alert("❌ Error al subir la imagen: "+e.message)}),this.socket.off("gallery:uploadProgress").on("gallery:uploadProgress",e=>{this.uploadProgress=e}))},addNewImage(e){this.media.unshift({type:"image",url:e.url,filename:e.filename})},async uploadImageInChunks(e){if(this.isUploading)return;this.isUploading=!0;const s=256*1024,o=Math.ceil(e.size/s);let i=0;const n=`${Date.now()}_${e.name}`;for(;i<o;){const a=i*s,l=Math.min(a+s,e.size),g=e.slice(a,l);try{const r=await this.readFileAsBuffer(g);if(this.socket&&this.socket.connected)this.socket.emit("gallery:uploadImageChunk",{filename:n,chunkIndex:i,totalChunks:o,buffer:r}),this.uploadProgress=Math.round((i+1)/o*100);else{console.error("❌ No hay conexión con el servidor."),this.isUploading=!1;return}}catch(r){console.error(`❌ Error al leer chunk ${i}:`,r),this.isUploading=!1;return}await new Promise(r=>setTimeout(r,50)),i++}this.socket.emit("gallery:completeUpload",{filename:n}),console.log(`📤 Subida completada: ${n}`)},readFileAsBuffer(e){return new Promise((s,o)=>{const i=new FileReader;i.onload=()=>s(i.result),i.onerror=o,i.readAsArrayBuffer(e)})},fetchAllImages(){const e=localStorage.getItem("mediaImages");e?(this.media=JSON.parse(e),console.log("🔄 Cargando imágenes desde localStorage...")):(console.log("📡 Solicitando imágenes..."),this.socket&&this.socket.emit("gallery:getAllImages")),(!e||!this.isImagesValid(e))&&(console.log("📡 Imágenes no válidas en localStorage, cargando desde el servidor..."),this.socket&&this.socket.emit("gallery:getAllImages"))},isImagesValid(e){try{const s=JSON.parse(e);return Array.isArray(s)&&s.every(o=>o.url&&o.filename)}catch{return!1}},saveImagesToLocalStorage(){localStorage.setItem("mediaImages",JSON.stringify(this.media))},setUploadingStatus(e){this.isUploading=e},deleteImage(e){this.socket.emit("gallery:deleteImage",{filename:e}),this.media=this.media.filter(s=>s.filename!==e),this.saveImagesToLocalStorage()}}}),P={data(){return{imagePreview:null,uploadCompleted:!1}},computed:{mediaStore(){return C()},images(){return this.mediaStore.media.filter(e=>e.type==="image")},isUploading(){return this.mediaStore.isUploading},uploadProgress(){return this.mediaStore.uploadProgress}},methods:{handleImageUpload(e){const s=e.target.files[0];if(s&&["image/jpeg","image/png","image/webp","image/gif"].includes(s.type)){const i=new FileReader;i.onload=()=>{this.imagePreview=i.result},i.onloadend=()=>{this.uploadCompleted=!1,this.mediaStore.uploadImageInChunks(s)},i.readAsDataURL(s),this.$refs.fileInput.value=""}else alert("Solo se permiten imágenes JPG, PNG, WEBP o GIF.")},cancelPreview(){this.imagePreview=null,this.uploadCompleted=!0,this.$refs.fileInput.value=""},viewImage(e){window.open(`https://felixqwerty.com/gallery/${e}`,"_blank")}},created(){this.mediaStore.connectSocket(),this.mediaStore.fetchAllImages(),this.$watch(()=>this.mediaStore.media,e=>{console.log("Imágenes actualizadas:",e)}),this.mediaStore.socket.on("gallery:uploadProgress",({filename:e,progress:s})=>{this.mediaStore.currentUploadingFile===e&&(this.mediaStore.uploadProgress=s)}),this.mediaStore.socket.on("gallery:imageUploaded",e=>{console.log("📡 Respuesta de subida de imagen:",e),this.mediaStore.setUploadingStatus(!1),e.status==="ok"?(this.uploadCompleted=!0,this.mediaStore.fetchAllImages()):alert("❌ Error al subir la imagen: "+e.message)})}},U={class:"container gallery-container py-5"},A={class:"upload-card p-4 mb-5 rounded-3 shadow-sm"},T={class:"row align-items-center"},z={class:"col-md-4"},N={class:"btn btn-primary w-100 py-3 d-flex align-items-center justify-content-center"},j={key:0,class:"preview-card p-4 mb-5 rounded-3 shadow-sm bg-light"},B={class:"d-flex justify-content-between align-items-center mb-3"},F={class:"text-center"},E=["src"],L={key:1,class:"upload-progress p-4 mb-5 rounded-3 shadow-sm bg-light"},R={class:"d-flex justify-content-between mb-2"},V={class:"fw-bold"},G={class:"progress",style:{height:"8px"}},M={class:"gallery-grid"},J={key:0,class:"empty-gallery text-center py-5"},O={key:1,class:"row g-4"},$={class:"gallery-item position-relative rounded-3 overflow-hidden shadow-sm"},q=["src","alt","onClick"],D={class:"item-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"},W=["onClick"];function H(e,s,o,i,n,a){return c(),d(p,null,[s[11]||(s[11]=t("section",{class:"gallery-hero position-relative"},[t("video",{class:"w-100 h-100 object-fit-cover",autoplay:"",loop:"",muted:"",playsinline:""},[t("source",{src:x,type:"video/mp4"})]),t("div",{class:"video-overlay"}),t("div",{class:"container position-relative z-index-1 h-100 d-flex align-items-center justify-content-center text-center"},[t("div",{class:"hero-content"},[t("h1",{class:"display-4 fw-bold text-white mb-3"},"Galería Visual"),t("p",{class:"lead text-white text-opacity-85 mb-0"},"Comparte tus momentos especiales")])])],-1)),t("div",U,[t("div",A,[t("div",T,[s[4]||(s[4]=t("div",{class:"col-md-8 mb-3 mb-md-0"},[t("h2",{class:"mb-0"},[t("i",{class:"bi bi-images me-2"}),m("Tu Colección")])],-1)),t("div",z,[t("label",N,[s[2]||(s[2]=t("i",{class:"bi bi-cloud-arrow-up fs-5 me-2"},null,-1)),s[3]||(s[3]=t("span",null,"Subir Imágenes",-1)),t("input",{ref:"fileInput",type:"file",onChange:s[0]||(s[0]=(...l)=>a.handleImageUpload&&a.handleImageUpload(...l)),accept:"image/jpeg,image/png,image/webp,image/gif",class:"d-none",multiple:""},null,544)])])])]),n.imagePreview&&!n.uploadCompleted?(c(),d("div",j,[t("div",B,[s[6]||(s[6]=t("h3",{class:"mb-0"},[t("i",{class:"bi bi-eye me-2"}),m("Previsualización")],-1)),t("button",{onClick:s[1]||(s[1]=(...l)=>a.cancelPreview&&a.cancelPreview(...l)),class:"btn btn-sm btn-outline-danger"},s[5]||(s[5]=[t("i",{class:"bi bi-x-lg me-1"},null,-1),m("Cancelar ")]))]),t("div",F,[t("img",{src:n.imagePreview,alt:"Previsualización",class:"preview-img img-fluid rounded shadow"},null,8,E)])])):h("",!0),a.isUploading?(c(),d("div",L,[t("div",R,[s[7]||(s[7]=t("span",null,[t("i",{class:"bi bi-cloud-arrow-up me-2"}),m("Subiendo archivo...")],-1)),t("span",V,w(a.uploadProgress)+"%",1)]),t("div",G,[t("div",{class:"progress-bar progress-bar-striped progress-bar-animated",style:I({width:`${a.uploadProgress}%`})},null,4)])])):h("",!0),t("div",M,[s[10]||(s[10]=t("h3",{class:"text-center mb-4 position-relative"},[t("span",{class:"section-title bg-white px-3"},"Tus Imágenes")],-1)),a.images.length===0?(c(),d("div",J,s[8]||(s[8]=[t("i",{class:"bi bi-images text-muted",style:{"font-size":"3rem"}},null,-1),t("h4",{class:"text-muted mt-3"},"Tu galería está vacía",-1),t("p",{class:"text-muted"},"Sube tu primera imagen usando el botón superior",-1)]))):(c(),d("div",O,[(c(!0),d(p,null,S(a.images,(l,g)=>(c(),d("div",{key:g,class:"col-12 col-sm-6 col-md-4 col-lg-3"},[t("div",$,[t("img",{src:"https://felixqwerty.com/gallery/"+l.filename,alt:l.filename,class:"gallery-img img-fluid w-100",onClick:r=>a.viewImage(l.filename)},null,8,q),t("div",D,[t("button",{onClick:_(r=>a.viewImage(l.filename),["stop"]),class:"btn btn-light btn-sm rounded-pill px-3"},s[9]||(s[9]=[t("i",{class:"bi bi-zoom-in me-1"},null,-1),m(" Ampliar ")]),8,W)])])]))),128))]))])])],64)}const X=v(P,[["render",H],["__scopeId","data-v-5d8283e6"]]);export{X as default};
